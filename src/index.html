<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0" /> -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#4c96d7" />
    <link rel="icon" href="icons/favicon.ico" type="image/x-icon" />
    <title>VocabViVocab</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div id="app">
      <!-- Tabs Navigation -->
      <nav class="tabs">
        <div class="tabs-content">
          <button class="tab-button active" data-tab="overview">
            Overview
          </button>
          <button class="tab-button" data-tab="lessions">Lessons</button>
          <!-- <button class="tab-button" data-tab="add">Add New</button> -->
          <button class="tab-button" data-tab="list">Vocabularies</button>
        </div>
      </nav>

      <!-- Tabs Content -->
      <section id="overview" class="tab-content active">
        <!-- <h1>Overview</h1> -->
        <!-- <p>Total Vocabulary: <span id="total-vocab">0</span></p>
        <p>
          Next Review: <span id="next-review-time">N/A</span> <br />
          Total to Review: <span id="total-review">0</span>
        </p> -->
        <!-- <button id="learn-btn">Start Learning</button> -->

        <div class="overview-card">
          <div class="card-header">
            <h2>Learned</h2>
            <p class="total-vocab" id="total-vocab">0</p>
          </div>
          <div class="word-level-table">
            <table>
              <thead>
                <tr>
                  <th>
                    <span class="info-icon" tabindex="0">
                      <p>Lv.1 <small>‚ÑπÔ∏è</small></p>
                      <div class="tooltip">Review after 1 hour</div>
                    </span>
                  </th>
                  <th>
                    <span class="info-icon" tabindex="0">
                      <p>Lv.2 <small>‚ÑπÔ∏è</small></p>
                      <div class="tooltip">Review after 6 hours</div>
                    </span>
                  </th>
                  <th>
                    <span class="info-icon" tabindex="0">
                      <p>Lv.3 <small>‚ÑπÔ∏è</small></p>
                      <div class="tooltip">Review after 1 day</div>
                    </span>
                  </th>
                  <th>
                    <span class="info-icon" tabindex="0">
                      <p>Lv.4 <small>‚ÑπÔ∏è</small></p>
                      <div class="tooltip">Review after 3 days</div>
                    </span>
                  </th>
                  <th>
                    <span class="info-icon" tabindex="0">
                      <p>Lv.5+ <small>‚ÑπÔ∏è</small></p>
                      <div class="tooltip" style="text-align: left">
                        <p>Level 5: Review after 7 days</p>
                        <p>Level 6: Review after 15 days</p>
                        <p>Level 7: Review after 30 days</p>
                        <p>Level 8+: Review after 45 days</p>
                      </div>
                    </span>
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td id="level-1-count">0</td>
                  <td id="level-2-count">0</td>
                  <td id="level-3-count">0</td>
                  <td id="level-4-count">0</td>
                  <td id="level-5-count">0</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="card-footer">
          </div>
          <p>Preparing for: <span id="next-review-time">N/A</span></p>
          <button id="learn-btn" class="start-learning-btn">
            Start Learning
          </button>
          <button id="practice-btn" class="practice-learning-btn">
            Practice Random Words
          </button>
        </div>

        <!-- Learning Levels Info Section -->
        <section id="level-info__section">
          <h3>How Learning Levels Work <span class="level-info__icon" aria-label="Learn More">‚ÑπÔ∏è</span></h3>
          <p>
            Each word starts at <strong>Level 1</strong>. Answer correctly to move up a level. Make a mistake? The word resets to <strong>Level 1</strong>.
            <br />
            Lower-level words appear more frequently. Higher-level words will show up occasionally to keep your knowledge sharp.
          </p>
        </section>

      <!-- Modal -->
      <div id="level-info__modal" class="level-info__modal">
        <button id="level-info__close-button" class="level-info__close-button" aria-label="Close modal">√ó</button>
        <div class="level-info__modal-content">
          <h2>How Our Spaced Repetition System Works</h2>
          <p>
            <strong>What is Spaced Repetition?</strong>
            <br />
            Spaced repetition is a proven learning technique that helps you remember words better by reviewing them at increasing intervals.
          </p>
          <p>
            <strong>How It Works in This App:</strong>
            <ul>
              <li><strong>Start at Level 1:</strong> Every new word starts at Level 1.</li>
              <li><strong>Level Up:</strong> Answer a word correctly, and it moves to the next level.</li>
              <li><strong>Reset on Mistake:</strong> If you answer a word incorrectly, it resets to Level 1.</li>
              <li><strong>Review Frequency:</strong> Lower-level words appear more frequently. Higher-level words appear less often.</li>
              <li><strong>Mastery:</strong> Words at high levels indicate strong understanding and are reviewed occasionally to keep your knowledge sharp.</li>
            </ul>
          </p>
        </div>
      </div>
      <div class="level-info__modal-backdrop"></div>

      </section>

      <section id="lessions" class="tab-content">
        <h1>Lessons</h1>
        <div id="lesson-container">
          <!-- LessonNavigation will render content here -->
        </div>
      </section>

      <section id="add" class="tab-content">
        <h1>Add New Vocabulary</h1>
        <form id="add-form">
          <textarea
            type="text"
            id="vocab-text"
            placeholder="Text(ex: Run)"
            onchange="processVocabText(event.target.value)"
            oninput="processVocabText(event.target.value)"
            required
          ></textarea>
          <input
            type="text"
            id="vocab-pronunciation"
            placeholder="Pronunciation(ex: /r ån/)"
          />
          <input type="text" id="vocab-type" placeholder="Type(ex: verb)" />
          <input
            type="text"
            id="vocab-translation"
            placeholder="Translations(comma separated, ex: Ch·∫°y)"
            required
          />
          <input type="url" id="vocab-image" placeholder="Image URL" />
          <textarea
            id="vocab-description"
            placeholder="Description(ex: To move quickly on foot.)"
          ></textarea>
          <button type="submit">Add Vocab</button>
        </form>

        <div>
          <p>
            Below is a pre-written prompt you can use to interact with ChatGPT.
            Follow these steps:
          </p>
          <ol>
            <li>Review or edit the text in the box below as needed.</li>
            <li>
              Click the <b>"Click to Copy"</b> button to copy the text to your
              clipboard.
            </li>
            <li>Paste the text into ChatGPT and ask for help.</li>
            <li>
              After receiving the response, copy the result from ChatGPT and
              paste it into the <b>Vocab Text</b> field in your application.
            </li>
          </ol>
          <textarea id="chatgpt-prompt" rows="15" cols="50">
Every time I send an English word, please provide its information in the following format:  
1. Must exactly match my sample.  
2. Just give me what I need, nothing more.  
3. The description should begin with a single sentence that defines the word. Then, include three sample sentences illustrating its usage.  

Here is an example:  

Word: Kidnap  
Type: Verb  
Pronunciation: /Ààk…™d.n√¶p/  
Translations: B·∫Øt c√≥c  
Description: To take someone away illegally by force, often to demand something in return.  
The criminals plan to kidnap the millionaire's child.  
The police arrested a gang that tried to kidnap a tourist.  
It's a crime to kidnap anyone, regardless of their background.  

Let's start with "kidnap".
          </textarea>
          <br />
          <button id="copy-button">Click to Copy</button>
        </div>
      </section>

      <section id="list" class="tab-content">
        <h1>All Vocabulary</h1>
        <div class="button-container">
          <button id="import-btn">Import</button>
          <input
            type="file"
            id="import-file"
            accept=".json"
            style="display: none"
          />
          <button id="export-btn">Export</button>
        </div>
        <div class="vocab-controls">
          <div class="search-container">
            <input 
              type="text" 
              id="vocab-search" 
              placeholder="Search vocabularies..."
              class="search-input"
            />
            <span class="search-icon">üîç</span>
          </div>
          <select id="filter-level">
            <option value="">All Levels</option>
            <option value="1">Level 1</option>
            <option value="2">Level 2</option>
            <option value="3">Level 3</option>
            <option value="4">Level 4</option>
            <option value="5">Level 5</option>
            <option value="6">Level 6</option>
            <option value="7">Level 7</option>
          </select>
        </div>
        
        <div id="vocab-list"></div>
        
        <div class="pagination-controls">
          <button id="prev-page" class="pagination-btn">Previous</button>
          <span id="page-info">Page <span id="current-page">1</span>/<span id="total-pages">1</span></span>
          <button id="next-page" class="pagination-btn">Next</button>
        </div>
      </section>

      <section id="settings" class="tab-content">
        <h1>Settings</h1>
        <div class="settings-section">
          <h2>Voice Settings</h2>
          <div class="setting-item">
            <label for="voice-selector">Select Voice:</label>
            <select id="voice-selector"></select>
          </div>
          <div class="setting-item">
            <label for="speech-rate">Speed:</label>
            <div class="speech-rate-control">
              <input 
                type="range" 
                id="speech-rate" 
                min="0.5" 
                max="2" 
                step="0.1" 
                value="1"
              >
              <span id="speech-rate-value">1.0x</span>
            </div>
          </div>
        </div>

        <div class="storage-info">
          <h3>Storage Usage</h3>
          <div class="storage-bar">
            <div id="storage-progress" class="storage-progress"></div>
          </div>
          <p id="storage-text">Used: <span id="storage-used">0</span> / <span id="storage-limit">5</span> MB</p>
        </div>
      </section>
    </div>

    <!-- Learning Modal -->
    <div id="learning-modal" class="modal">
      <div class="modal-content">
        

        <!-- Progress Bar -->
        <button id="stop-review-btn" class="top-button">√ó</button>
        <div id="progress-bar-container">
          <div id="progress-bar"></div>
          <p id="progress-text">0/0</p>
        </div>

        <!-- Vocabulary Content -->
        <div id="vocab-display">
          <div id="vocab-image-container">
            <img id="vocab-image" src="" alt="" style="display: none" />
          </div>
          <p id="vocab-textt">Hi</p>
          <p id="vocab-descriptionn"></p>
        </div>

        <!-- Answer Options -->
        <div id="answer-options"></div>
        
        <!-- Submit Button -->
        <button id="submit-answer-btn">Submit</button>
        <button id="skip-answer-btn">Skip</button>
        <div id="remember-levels"></div>
      </div>
    </div>

    <!-- Overview Modal -->
    <div id="overview-modal" class="modal">
      <div class="modal-content">
        <div class="overview-header">
          <h2>Performance</h2>
          <button id="back-to-home">Home</button>
        </div>
        
        <div class="session-time">
          <span class="time-icon">‚è±Ô∏è</span>
          <span id="time-spent"></span> seconds
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">üìö</div>
            <div class="stat-value" id="total-reviewed">0</div>
            <div class="stat-label">Total</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-value" id="correct-answers">0</div>
            <div class="stat-label">Correct</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚ùå</div>
            <div class="stat-value" id="incorrect-attempts">0</div>
            <div class="stat-label">Incorrect</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚≠ê</div>
            <div class="stat-value">
              <span id="accuracy-rate">0</span>%
            </div>
            <div class="stat-label">Accuracy</div>
          </div>
        </div>
        <ul id="performance-breakdown"></ul>
        
        <!-- <button id="restart-learning">Restart Learning</button> -->
      </div>
    </div>

    <div class="fixed-menu">
      <button id="practice-badge" class="practice-badge">
        <span id="review-count" class="review-count">0</span>
        üìù
      </button>
      <button id="fixed-add-button" data-tab="add" class="tab-button fixed-add-button">‚úö</button>
      <button class="tab-button fixed-add-button" data-tab="settings">‚öôÔ∏è</button>
      <button id="reload-app" class="tab-button fixed-add-button">‚ôªÔ∏è</button>
    </div>



    <div id="app-version" class="version-display"></div>
    <!-- <button id="reload-app" class="reload-btn">üîÑ</button> -->

    <script src="/index.js"></script>
    <script src="lesson.js"></script>
    <script src="components/LessonNavigation.js"></script>
    <script src="app.js"></script>
    <script src="/speech.js"></script>
    <script src="/learn-progress.js"></script>

    <script>
      // Function to get version from the manifest and display it
      function displayAppVersion() {
        fetch("/manifest.json")
          .then((response) => response.json())
          .then((data) => {
            const version = data.version; // Assuming the version field exists in manifest.json
            document.getElementById(
              "app-version"
            ).textContent = `v${version}`;
          })
          .catch((error) => {
            console.error("Error loading manifest.json:", error);
          });
      }

      // Call the function to display the version
      displayAppVersion();

      // Register PWA
      function checkForUpdate() {
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker.register("/sw.js").then((registration) => {
            registration.addEventListener("updatefound", () => {
              const newWorker = registration.installing;
      
              newWorker.addEventListener("statechange", () => {
                if (newWorker.state === "installed") {
                  if (navigator.serviceWorker.controller) {
                    // New content is available, refresh the page
                    newWorker.postMessage({ action: "skipWaiting" });
                    alert("üöÄ A new version of the app is available! Reload now to enjoy the latest features and improvements")
                  }
                }
              });
            });
          });
      
          // Listen for controlling new service worker
          // let refreshing = false;
          // navigator.serviceWorker.addEventListener("controllerchange", () => {
          //  if (!refreshing) {
          //    refreshing = true;
          //    window.location.reload(); // Reload the page when new SW takes control
          //  }
          // });
        }
      }

      checkForUpdate();

      // Reload Button functionality
      document
      .getElementById("reload-app")
      .addEventListener("click", async () => {
        if (navigator.onLine) {
          window.location.reload(true); // Force reload from server
        } else {
          alert("You are offline. Cannot clear cache at this time.");
        }
      });
      

    </script>
  </body>
</html>
